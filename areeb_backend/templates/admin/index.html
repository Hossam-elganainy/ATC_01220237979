{% extends 'admin/base.html' %}
{% load i18n %}

{% block breadcrumbs %}{% endblock %}

{% block title %}
    {% if subtitle %}{{ subtitle }} | {% endif %}{{ title }} | {{ site_title|default:_('Django site admin') }}
{% endblock %}

{% block branding %}
    {% include "unfold/helpers/site_branding.html" %}
{% endblock %}

{% get_current_language_bidi as LANGUAGE_BIDI %}
{% if LANGUAGE_BIDI %}
    {% block extrastyle %}
        <style>
        </style>
    {% endblock %}
{% endif %}

{% block content %}
<div class="container mx-auto p-6">
    <!-- Dashboard Title -->
    <h1 class="text-3xl font-bold mb-8 text-gray-900 dark:text-white">
        {% trans 'Dashboard' %}
    </h1>

    {% if dashboard %}
        
        <!-- Stats Cards Grid (5 columns on large screens) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Branches Card -->
            <div class="border flex flex-col flex-grow overflow-hidden p-6 relative rounded shadow-sm dark:border-base-800">
                <div class="flex-grow relative">
                    <p class="leading-relaxed mb-0 text-sm text-gray-700 dark:text-gray-300">
                        {% trans "Branches" %}
                    </p>
                    <div class="font-semibold text-2xl text-gray-900 dark:text-white tracking-tight">
                        {{ dashboard.number_of_branches }}
                    </div>
                    
                    {% comment %} <div class="absolute {% if LANGUAGE_BIDI %}left-0{% else %}right-0{% endif %} top-0"> {% endcomment %}
                    <div class="absolute right-0 top-0">

                        <span class="inline-block font-semibold leading-normal px-2 py-1 rounded text-xxs uppercase whitespace-nowrap bg-primary-100 text-primary-700 dark:bg-primary-500/20 dark:text-primary-400">
                            Last 7 days
                        </span>
                    </div>
                </div>
                
                <div class="border-t flex items-center -mb-6 -mx-6 mt-6 pb-2 pt-2 px-6 text-sm dark:border-base-800">
                    <strong class="text-green-700 font-semibold dark:text-green-400">+6.84%</strong> progress from last week
                </div>
            </div>
            <!-- end card -->

            <!-- Services Card -->
            <div class="border flex flex-col flex-grow overflow-hidden p-6 relative rounded shadow-sm dark:border-base-800">
                <div class="flex-grow relative">
                    <p class="leading-relaxed mb-0 text-sm text-gray-700 dark:text-gray-300">
                        {% trans "Employees" %}
                    </p>
                    <div class="font-semibold text-2xl text-gray-900 dark:text-white tracking-tight">
                        {{ dashboard.number_of_employees }}
                    </div>
                    
                    {% comment %} <div class="absolute {% if LANGUAGE_BIDI %}left-0{% else %}right-0{% endif %} top-0"> {% endcomment %}
                        <div class="absolute right-0 top-0">
                        <span class="inline-block font-semibold leading-normal px-2 py-1 rounded text-xxs uppercase whitespace-nowrap bg-primary-100 text-primary-700 dark:bg-primary-500/20 dark:text-primary-400">
                            Last 7 days
                        </span>
                    </div>
                </div>
                
                <div class="border-t flex items-center -mb-6 -mx-6 mt-6 pb-2 pt-2 px-6 text-sm dark:border-base-800">
                    <strong class="text-green-700 font-semibold dark:text-green-400">+6.84%</strong> progress from last week
                </div>
            </div>
            <!-- end card -->

            <!-- Reservations Card -->
            <div class="border flex flex-col flex-grow overflow-hidden p-6 relative rounded shadow-sm dark:border-base-800">
                <div class="flex-grow relative">
                    <p class="leading-relaxed mb-0 text-sm text-gray-700 dark:text-gray-300">
                        {% trans "Companies" %}
                    </p>
                    <div class="font-semibold text-2xl text-gray-900 dark:text-white tracking-tight">
                        {{ dashboard.number_of_companies }}
                    </div>
                    
                    {% comment %} <div class="absolute {% if LANGUAGE_BIDI %}left-0{% else %}right-0{% endif %} top-0"> {% endcomment %}
                        <div class="absolute right-0 top-0">
                        <span class="inline-block font-semibold leading-normal px-2 py-1 rounded text-xxs uppercase whitespace-nowrap bg-primary-100 text-primary-700 dark:bg-primary-500/20 dark:text-primary-400">
                            Last 7 days
                        </span>
                    </div>
                </div>
                
                <div class="border-t flex items-center -mb-6 -mx-6 mt-6 pb-2 pt-2 px-6 text-sm dark:border-base-800">
                    <strong class="text-green-700 font-semibold dark:text-green-400">+6.84%</strong> progress from last week
                </div>
            </div>
            <!-- end card -->

            <!-- Revenue Card -->
            <div class="border flex flex-col flex-grow overflow-hidden p-6 relative rounded shadow-sm dark:border-base-800">
                <div class="flex-grow relative">
                    <p class="leading-relaxed mb-0 text-sm text-gray-700 dark:text-gray-300">
                        {% trans "Total Revenue" %}
                    </p>
                    <div class="font-semibold text-2xl text-gray-900 dark:text-white tracking-tight">
                         {{ dashboard.total_revenue }} {% trans 'SAR'%}
                    </div>
                    
                    {% comment %} <div class="absolute {% if LANGUAGE_BIDI %}left-0{% else %}right-0{% endif %} top-0"> {% endcomment %}
                        <div class="absolute right-0 top-0">
                        <span class="inline-block font-semibold leading-normal px-2 py-1 rounded text-xxs uppercase whitespace-nowrap bg-primary-100 text-primary-700 dark:bg-primary-500/20 dark:text-primary-400">
                            Last 7 days
                        </span>
                    </div>
                </div>
                
                <div class="border-t flex items-center -mb-6 -mx-6 mt-6 pb-2 pt-2 px-6 text-sm dark:border-base-800">
                    <strong class="text-green-700 font-semibold dark:text-green-400">+6.84%</strong> progress from last week
                </div>
            </div>
            <!-- end card -->
        </div>

        <!-- Charts Grid (2 columns on medium and larger screens) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Last Week Reservations Chart (Area Chart) -->
            <div class="border flex flex-col flex-grow overflow-hidden p-6 relative rounded shadow-sm dark:border-base-800">
                <div class="flex-grow relative">
                    <p class="">
                        {% trans "Last Week Reservations" %}
                    </p>
                    <div id="chart1" class="w-full h-[300px] mt-4 "></div>
                </div>
            </div>
            <!-- end chart -->

            <!-- Branches Chart (Pie Chart) -->
            <div class="border flex flex-col flex-grow overflow-hidden p-6 relative rounded shadow-sm dark:border-base-800">
                <div class="flex-grow relative">
                    <p class="leading-relaxed mb-0 text-sm text-gray-700 dark:text-gray-300">
                        {% trans "Reservations per Event" %}
                    </p>
                    <div id="chart2" class="w-full h-[300px] mt-4"></div>
                </div>
            </div>
            <!-- end chart -->
        </div>
        <!-- end charts grid -->

    

    <!-- New Tables Section - Third Row -->
    <div class="grid grid-cols-1 gap-6 mt-6">
        <!-- Tables Container -->
        <div class="border rounded shadow-sm dark:border-base-800 overflow-hidden">
            <div class="grid grid-cols-1 lg:grid-cols-1 gap-6 p-6">
                
                <!-- Top Services Table -->
                <div class="col-span-1">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
                        {% trans "Top Services (Most Booked)" %}
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-700 dark:text-gray-300">
                            <thead class="bg-gray-50 dark:bg-base-900">
                                <tr>
                                    <th class="px-4 py-2 text-left">{% trans "Service" %}</th>
                                    <th class="px-4 py-2 text-left">{% trans "Bookings" %}</th>
                                    <th class="px-4 py-2 text-left">{% trans "Revenue" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in dashboard.top_services %}
                                    <tr class="border-t dark:border-base-800">
                                        <td class="px-4 py-2">{{ service.name }}</td>
                                        <td class="px-4 py-2">{{ service.reservations_count }}</td>
                                        <td class="px-4 py-2">{{ service.revenue }} {% trans "SAR" %}</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="px-4 py-2 text-center">{% trans "No services data" %}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                
            </div>
        </div>
    </div>
    <!-- End Tables Section -->

    <!-- Font Awesome and ApexCharts Scripts -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script>
        // Area Chart (Last Week Reservations)
        const options1 = {
            chart: {
                type: 'area',
                height: 300,
                background: 'transparent',
                toolbar: {
                    show: false
                }
            },
            series: [{
                name: 'reservations',
                data: {{ dashboard.area_chart_data.data|safe }}
            }],
            xaxis: {
                categories: {{ dashboard.area_chart_data.labels|safe }},
                labels: {
                    show: true,
                    style: {
                        colors: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151'
                    }
                },

            },
            colors: ['#14b8a6'], // Tailwind teal-500
            theme: {
                mode: document.documentElement.classList.contains('dark') ? 'dark' : 'light'
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 2
            },
            grid: {
                borderColor: document.documentElement.classList.contains('dark') ? '#4a5568' : '#e2e8f0'
            },
            tooltip: {
                theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light'
            }
        };
        const chartElement = document.querySelector("#chart1");
        const chart1 = new ApexCharts(chartElement, options1);
        chart1.render();
        console.log(chartElement)


        {% comment %} if (!chartElement) {
            console.error("Chart container #chart1 not found in the DOM!");
        } else {
            // Log the options to verify the categories
            console.log("Chart options:", options1);
            
            // Render the chart
            const chart1 = new ApexCharts(chartElement, options1);
            chart1.render();
        }  {% endcomment %}

        // Pie Chart (Branches)
        const options2 = {
            chart: {
                type: 'pie',
                height: 300,
                background: 'transparent',
                toolbar: {
                    show: false
                }
            },
            series: {{ dashboard.pie_chart_data.data|safe }},
            labels: {{ dashboard.pie_chart_data.labels|safe }},
            colors: [
                '#14b8a6', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
                '#14b8a6', '#6b7280', '#ec4899', '#7c3aed', '#f3f4f6'
            ],
            legend: {
                position: 'bottom',
                labels: {
                    colors: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151'
                }
            },
            theme: {
                mode: document.documentElement.classList.contains('dark') ? 'dark' : 'light'
            },
            dataLabels: {
                enabled: true,
                style: {
                    colors: [document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151']
                }
            }
        };
        const chart2 = new ApexCharts(document.querySelector("#chart2"), options2);
        chart2.render();

        // Theme Switch Listener
        const observer = new MutationObserver(() => {
            const isDark = document.documentElement.classList.contains('dark');
            chart1.updateOptions({
                theme: { mode: isDark ? 'dark' : 'light' },
                xaxis: {categories: {{ dashboard.area_chart_data.labels|safe }}, labels: { style: { colors: isDark ? '#d1d5db' : '#374151' } } },
                grid: { borderColor: isDark ? '#4a5568' : '#e2e8f0' },
                tooltip: { theme: isDark ? 'dark' : 'light' }
            });
            chart2.updateOptions({
                theme: { mode: isDark ? 'dark' : 'light' },
                legend: { labels: { colors: isDark ? '#d1d5db' : '#374151' } },
                dataLabels: { style: { colors: [isDark ? '#d1d5db' : '#374151'] } }
            });
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });


    // Update theme switch listener to include new charts
    observer.disconnect();
    const updatedObserver = new MutationObserver(() => {
        const isDark = document.documentElement.classList.contains('dark');
        chart1.updateOptions({
            theme: { mode: isDark ? 'dark' : 'light' },
            xaxis: { categories: {{ dashboard.area_chart_data.labels|safe }},labels: { style: { colors: isDark ? '#d1d5db' : '#374151' } } },
            grid: { borderColor: isDark ? '#4a5568' : '#e2e8f0' },
            tooltip: { theme: isDark ? 'dark' : 'light' }
        });
        chart2.updateOptions({
            theme: { mode: isDark ? 'dark' : 'light' },
            legend: { labels: { colors: isDark ? '#d1d5db' : '#374151' } },
            dataLabels: { style: { colors: [isDark ? '#d1d5db' : '#374151'] } }
        });
    });
    updatedObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    </script>
    {% else %}
        <div class="flex items-center justify-center h-64">
            <h1 class="text-4xl font-bold text-center text-gray-800 dark:text-white">
                Hello {{ request.user.first_name }} {{ request.user.last_name }}!
            </h1>
        </div>
    {% endif %}
{% endblock %}